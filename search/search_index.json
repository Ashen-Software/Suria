{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Suria","text":"<p>Aqu\u00ed encontrar\u00e1s orientaci\u00f3n sobre la arquitectura, la API y el esquema de la base de datos.</p>"},{"location":"#contenido","title":"Contenido","text":"<ul> <li>Arquitectura: Diagramas y decisiones de dise\u00f1o</li> <li>API: Documentaci\u00f3n de endpoints</li> <li>Base de datos: Esquemas y modelos</li> </ul>"},{"location":"#frontend-y-dashboards","title":"Frontend y Dashboards","text":"<ul> <li>Aplicaci\u00f3n React + Vite con TypeScript, Tailwind y DaisyUI.</li> <li>Dashboards energ\u00e9ticos para:</li> <li>Declaraci\u00f3n de gas natural (MinMinas).</li> <li>Regal\u00edas por campo (ANH).</li> <li>Proyecciones UPME (gas natural, energ\u00eda el\u00e9ctrica, potencia m\u00e1xima, capacidad instalada).</li> <li>Vista Integrada (<code>/integrado</code>) que cruza:</li> <li>Demanda de gas y electricidad UPME (ESC_MEDIO).</li> <li>Oferta de gas declarada (<code>fact_oferta_gas</code>).</li> <li>Regal\u00edas acumuladas (<code>fact_regalias</code>).</li> <li>Incluye un bot\u00f3n de \u201cGenerar an\u00e1lisis con IA\u201d que usa el servicio LLM para producir un resumen ejecutivo basado en los datos cargados.</li> </ul>"},{"location":"#fuentes-de-datos","title":"Fuentes de datos","text":""},{"location":"#regalias-por-campo-anh","title":"Regal\u00edas por campo (ANH)","text":"<p>Liquidaci\u00f3n definitiva de regal\u00edas por campo de hidrocarburos desde 2010.</p> <ul> <li>Autor: Agencia Nacional de Hidrocarburos</li> <li>API: Socrata \u2014 j7js-yk74</li> </ul>"},{"location":"#declaracion-de-produccion-minminas","title":"Declaraci\u00f3n de producci\u00f3n (MinMinas)","text":"<p>Producci\u00f3n declarada por productores y comercializadores de gas natural.</p> <ul> <li>Autor: Ministerio de Minas y Energ\u00eda</li> <li>Formato: XLSX por periodo</li> <li>Enlace: Gas natural \u2014 MinMinas</li> </ul>"},{"location":"#proyecciones-upme","title":"Proyecciones UPME","text":"M\u00e9trica Unidad Descripci\u00f3n Demanda Gas Natural GBTUD Por categor\u00eda (Industrial, Residencial, etc.) Energ\u00eda El\u00e9ctrica GWh Por \u00e1rea el\u00e9ctrica Potencia M\u00e1xima MW Por \u00e1rea y escenario Capacidad Instalada MW Generaci\u00f3n Distribuida <ul> <li>Autor: UPME</li> <li>Formato: Anexos XLSX</li> <li>Enlace: Proyecciones de demanda \u2014 UPME</li> </ul>"},{"location":"api/endpoints/","title":"Endpoints","text":""},{"location":"arquitectura/directorios/","title":"Directorios","text":""},{"location":"arquitectura/directorios/#proceso-etl","title":"Proceso ETL","text":"<pre><code>/Suria/\n\u2502\n\u251c\u2500\u2500 data/                        \u2190 ETL\n\u2502   \u251c\u2500\u2500 Dockerfile\n\u2502   \u251c\u2500\u2500 requirements.txt\n\u2502   \u251c\u2500\u2500 scheduler/\n\u2502   \u2502   \u251c\u2500\u2500 runner.py           \u2190 Ejecuta workflows desde cron\n\u2502   \u2502   \u2514\u2500\u2500 jobs.py\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 workflows/\n\u2502   \u2502   \u251c\u2500\u2500 check_updates/\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 run.py           \u2190 Detecta cambios\n\u2502   \u2502   \u251c\u2500\u2500 full_etl/\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 run.py           \u2190 Ejecuta descargas seg\u00fan fuente\n\u2502   \u2502   \u2514\u2500\u2500 sources_config.json  \u2190 Fuentes + metadatos\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 extraction/\n\u2502   \u2502   \u251c\u2500\u2500 scrapers/\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 declaracion/     \u2190 Scrapers MinMinas\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 proyeccion/      \u2190 Scrapers UPME\n\u2502   \u2502   \u2502       \u251c\u2500\u2500 config.py\n\u2502   \u2502   \u2502       \u251c\u2500\u2500 normalizer.py\n\u2502   \u2502   \u2502       \u2514\u2500\u2500 schema/      \u2190 Esquemas SQL por m\u00e9trica\n\u2502   \u2502   \u251c\u2500\u2500 api_clients/         \u2190 Cliente requests/API\n\u2502   \u2502   \u2514\u2500\u2500 common/              \u2190 Utils comunes (fechas, hash, etc.)\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 logs_config/\n\u2502   \u2502   \u251c\u2500\u2500 logs/                \u2190 Archivos persistentes\n\u2502   \u2502   \u2514\u2500\u2500 logger.py            \u2190 Config de logs\n\u2502   \u2502\n\u2502   \u2514\u2500\u2500 services/\n\u2502       \u2514\u2500\u2500 backend_client.py    \u2190 Comunicaci\u00f3n con API del backend\n</code></pre>"},{"location":"arquitectura/implementacion/","title":"Implementaci\u00f3n","text":""},{"location":"arquitectura/implementacion/#plan-de-implementacion-por-hitos","title":"Plan de Implementaci\u00f3n por Hitos","text":""},{"location":"arquitectura/implementacion/#hito-1-infraestructura-base","title":"Hito 1: Infraestructura Base","text":"<ul> <li> <p>Configuraci\u00f3n de repositorio y GitHub Actions</p> </li> <li> <p>Esquema de base de datos en Supabase</p> </li> <li> <p>Sistema de logging b\u00e1sico</p> </li> </ul>"},{"location":"arquitectura/implementacion/#hito-2-deteccion-de-cambios","title":"Hito 2: Detecci\u00f3n de Cambios","text":"<ul> <li> <p>Scrapers livianos para las fuentes:</p> <ul> <li>ANH (API Socrata)</li> <li>UPME (Proyecciones: Gas, Electricidad, Potencia, Capacidad)</li> <li>MinMinas (Declaraci\u00f3n de Producci\u00f3n)</li> </ul> </li> <li> <p>L\u00f3gica de comparaci\u00f3n y trigger</p> </li> <li> <p>Configuraci\u00f3n de alertas b\u00e1sicas</p> </li> </ul>"},{"location":"arquitectura/implementacion/#hito-3-etl-completo","title":"Hito 3: ETL Completo","text":"<ul> <li> <p>Contenedor Playwright + dependencias</p> </li> <li> <p>Pipelines de transformaci\u00f3n por fuente</p> </li> <li> <p>Mecanismos de carga y UPSERT</p> </li> <li> <p>Esquemas SQL modulares por m\u00e9trica</p> </li> </ul>"},{"location":"arquitectura/implementacion/#hito-4-dashboard","title":"Hito 4: Dashboard","text":"<ul> <li> <p>Aplicaci\u00f3n React base</p> </li> <li> <p>Visualizaciones principales</p> </li> <li> <p>Despliegue en DigitalOcean/Coolify</p> </li> </ul>"},{"location":"arquitectura/implementacion/#hito-5-monitorizacion-avanzada","title":"Hito 5: Monitorizaci\u00f3n Avanzada","text":"<ul> <li> <p>Dashboards de m\u00e9tricas ETL</p> </li> <li> <p>Alertas proactivas</p> </li> <li> <p>Documentaci\u00f3n operativa</p> </li> </ul>"},{"location":"arquitectura/overview/","title":"Overview","text":""},{"location":"arquitectura/overview/#arquitectura-detallada","title":"Arquitectura Detallada","text":""},{"location":"arquitectura/overview/#1-orquestacion-y-ejecucion-github-actions","title":"1. Orquestaci\u00f3n y Ejecuci\u00f3n (GitHub Actions)","text":""},{"location":"arquitectura/overview/#workflows-implementados","title":"Workflows Implementados","text":"<p>check-updates.yml\u00a0(Ejecuci\u00f3n Semanal/Mensual)</p> <ul> <li> <p>Trigger:\u00a0Cron programado / activaci\u00f3n manual</p> </li> <li> <p>Funci\u00f3n:\u00a0Verifica cambios en fuentes usando Requests + BeautifulSoup</p> </li> <li> <p>Salida:\u00a0Dispara ETL completo solo si detecta cambios</p> </li> <li> <p>Costo:\u00a0M\u00ednimo (ejecuci\u00f3n r\u00e1pida sin contenedores)</p> </li> </ul> <p>full-etl.yml\u00a0(Completo - Solo cuando hay cambios)</p> <ul> <li> <p>Trigger:\u00a0Desde check-updates o manual</p> </li> <li> <p>Contenedor:\u00a0Playwright + Python para extracci\u00f3n robusta</p> </li> <li> <p>Proceso:\u00a0Extracci\u00f3n \u2192 Transformaci\u00f3n \u2192 Carga</p> </li> <li> <p>Costo:\u00a0Solo cuando es necesario (2-3 meses)</p> </li> </ul>"},{"location":"arquitectura/overview/#2-sistema-de-logs-y-monitorizacion","title":"2. Sistema de Logs y Monitorizaci\u00f3n","text":""},{"location":"arquitectura/overview/#estrategia-de-logs-multi-nivel","title":"Estrategia de Logs Multi-nivel","text":"<p>Nivel 1: Logs Estructurados en GitHub Actions</p> <ul> <li> <p>Logs nativos de ejecuci\u00f3n de workflows</p> </li> <li> <p>Captura de stdout/stderr de todos los scripts</p> </li> <li> <p>Retenci\u00f3n autom\u00e1tica seg\u00fan pol\u00edtica de GitHub</p> </li> </ul> <p>Nivel 2: M\u00e9tricas de Performance</p> <ul> <li> <p>Tiempos de ejecuci\u00f3n por fuente</p> </li> <li> <p>Volumen de datos procesados</p> </li> <li> <p>Tasa de \u00e9xito/error por componente</p> </li> </ul>"},{"location":"arquitectura/overview/#sistema-de-alertas-multi-canal","title":"Sistema de Alertas Multi-canal","text":"<p>1. GitHub Native Integrations</p> <ul> <li> <p>Notificaciones email nativas sobre fallos de workflows</p> </li> <li> <p>Configuraci\u00f3n directa en repository settings</p> </li> </ul> <p>2. Custom Email Service</p> <ul> <li>Notificaciones para stakeholders no t\u00e9cnicos (SMTP gratuito)</li> </ul>"},{"location":"arquitectura/overview/#3-procesamiento-de-datos-etl","title":"3. Procesamiento de Datos (ETL)","text":""},{"location":"arquitectura/overview/#tecnologias-clave","title":"Tecnolog\u00edas Clave","text":"<ul> <li> <p>Python 3.12+: Lenguaje principal</p> </li> <li> <p>Playwright: Extracci\u00f3n robusta en sitios complejos</p> </li> <li> <p>Pandas: Transformaci\u00f3n y limpieza de datos</p> </li> <li> <p>BeautifulSoup: Scraping liviano para detecci\u00f3n</p> </li> <li> <p>Supabase Python Client: Carga eficiente</p> </li> </ul>"},{"location":"arquitectura/overview/#estrategia-de-procesamiento","title":"Estrategia de Procesamiento","text":"<ol> <li> <p>Extracci\u00f3n Resiliente: Reintentos autom\u00e1ticos con backoff</p> </li> <li> <p>Validaci\u00f3n en Tiempo Real: Schemas, rangos, consistencia</p> </li> <li> <p>Procesamiento Incremental: Solo datos nuevos/cambiados</p> </li> <li> <p>Idempotencia: UPSERTs para evitar duplicados</p> </li> </ol>"},{"location":"arquitectura/overview/#4-almacenamiento-y-backend-supabase","title":"4. Almacenamiento y Backend (Supabase)","text":""},{"location":"arquitectura/overview/#esquema-de-base-de-datos","title":"Esquema de Base de Datos","text":"<p>El sistema utiliza un modelo estrella (star schema) con:</p> <ul> <li>Dimensiones compartidas: <code>dim_tiempo</code>, <code>dim_territorios</code>, <code>dim_campos</code>, <code>dim_areas_electricas</code>, <code>dim_resoluciones</code></li> <li>Tablas de hechos: </li> <li><code>fact_regalias</code> (ANH)</li> <li><code>fact_demanda_gas_natural</code> (UPME)</li> <li><code>fact_energia_electrica</code> (UPME)</li> <li><code>fact_potencia_maxima</code> (UPME)</li> <li><code>fact_capacidad_instalada</code> (UPME)</li> <li><code>fact_oferta_gas</code> (MinMinas)</li> </ul> <p>Ver esquema.md para detalles completos.</p>"},{"location":"arquitectura/overview/#optimizaciones-para-dashboard","title":"Optimizaciones para Dashboard","text":"<ul> <li> <p>Vistas materializadas para consultas frecuentes</p> </li> <li> <p>\u00cdndices en campos de filtro com\u00fan (fecha, entidad, territorio)</p> </li> <li> <p>Pol\u00edticas RLS para seguridad de datos</p> </li> </ul>"},{"location":"arquitectura/overview/#5-frontend-y-despliegue","title":"5. Frontend y Despliegue","text":""},{"location":"arquitectura/overview/#stack-tecnologico","title":"Stack Tecnol\u00f3gico","text":"<ul> <li> <p>React 19 + Vite + TypeScript: Aplicaci\u00f3n SPA principal</p> </li> <li> <p>Tailwind CSS + DaisyUI: Estilizaci\u00f3n, layout y componentes UI</p> </li> <li> <p>Supabase JS Client: Conexi\u00f3n directa a la base de datos (lectura desde el frontend)</p> </li> <li> <p>TanStack React Query: Capa de data fetching, cach\u00e9 y paginaci\u00f3n incremental (<code>useInfiniteQuery</code>)</p> </li> <li> <p>TanStack React Table: Tablas interactivas con b\u00fasqueda y paginaci\u00f3n en el navegador</p> </li> <li> <p>Recharts: Visualizaciones (l\u00edneas, \u00e1reas, barras, pies) para dashboards energ\u00e9ticos</p> </li> <li> <p>OpenAI Chat Completions API: Servicio de IA para el chatbot y an\u00e1lisis autom\u00e1ticos del dashboard integrado</p> </li> </ul>"},{"location":"arquitectura/overview/#estrategia-de-despliegue","title":"Estrategia de Despliegue","text":"<ul> <li> <p>Vite dev server en local (<code>npm run dev</code>), con build est\u00e1tico listo para CD (Vercel/Netlify/DigitalOcean)</p> </li> <li> <p>Variables de Entorno: <code>VITE_SUPABASE_URL</code>, <code>VITE_SUPABASE_ANON_KEY</code>, <code>VITE_OPENAI_API_KEY</code>, <code>VITE_OPENAI_MODEL</code>, etc.</p> </li> <li> <p>CDN Global (seg\u00fan plataforma de despliegue): Distribuci\u00f3n optimizada de assets</p> </li> </ul>"},{"location":"arquitectura/overview/#6-frontend-paginas-y-vistas-clave","title":"6. Frontend: P\u00e1ginas y Vistas Clave","text":"<ul> <li>Home (<code>/</code>): Portada y explicaci\u00f3n general de Suria.</li> <li>Integrado (<code>/integrado</code>): Dashboard que cruza UPME (demanda gas y el\u00e9ctrica), Declaraci\u00f3n MinMinas (<code>fact_oferta_gas</code>) y regal\u00edas ANH (<code>fact_regalias</code>), con:<ul> <li>KPIs integrados (demanda total gas, demanda el\u00e9ctrica, oferta gas, regal\u00edas acumuladas).</li> <li>Reconciliaci\u00f3n oferta vs demanda de gas (series anuales agregadas).</li> <li>Serie de regal\u00edas anuales.</li> <li>Tabla integrada por a\u00f1o con demanda gas, oferta gas, brecha, demanda el\u00e9ctrica y regal\u00edas.</li> <li>Bot\u00f3n \u201cGenerar an\u00e1lisis con IA\u201d que llama al servicio de LLM y genera un resumen ejecutivo basado en los datos cargados.</li> </ul> </li> <li>Declaraci\u00f3n de Gas (<code>/declaracion-gas</code>) y Regal\u00edas (<code>/regalias</code>): Dashboards detallados por fuente, con visualizaciones, estad\u00edsticas y tabla granular.</li> <li>UPME (<code>/upme</code>): P\u00e1gina de entrada a los m\u00f3dulos de demanda de gas natural, energ\u00eda el\u00e9ctrica, potencia m\u00e1xima y capacidad instalada.</li> <li>Dimensiones (<code>/dimensiones</code>): Cat\u00e1logo maestro de <code>dim_tiempo</code>, <code>dim_territorios</code> y \u00e1reas el\u00e9ctricas.</li> </ul> <p>Todas las vistas que consumen tablas de hechos grandes (<code>fact_oferta_gas</code>, <code>fact_regalias</code>, <code>fact_demanda_gas_natural</code>, <code>fact_energia_electrica</code>, <code>fact_potencia_maxima</code>, <code>fact_capacidad_instalada</code>) siguen un mismo patr\u00f3n:</p> <ol> <li>Servicios Supabase paginados (<code>getPage(from, to)</code> con <code>.range</code>) para evitar <code>statement timeout</code> en consultas muy grandes.</li> <li>Capa de helpers (<code>loadXPage(page, pageSize)</code>) que reciben un \u00edndice de p\u00e1gina y tama\u00f1o de p\u00e1gina API (por defecto 5000 filas).</li> <li><code>useInfiniteQuery</code> en el frontend para traer p\u00e1ginas sucesivas y construir un <code>flatData</code> acumulado sobre el que se calculan gr\u00e1ficos, KPIs y tablas.</li> <li>Carga progresiva y skeletons: el usuario empieza a ver estructura y primeros datos mientras siguen llegando p\u00e1ginas adicionales en background.</li> </ol> <p>Este patr\u00f3n est\u00e1 aplicado tanto en los m\u00f3dulos de Declaraci\u00f3n/Regal\u00edas como en todos los m\u00f3dulos UPME.</p> <p></p>"},{"location":"database/esquema/","title":"Esquema de Base de Datos","text":"<p>Estructura de la base de datos en Supabase (PostgreSQL) para el sistema ETL de datos energ\u00e9ticos.</p>"},{"location":"database/esquema/#diagrama-relacional","title":"Diagrama Relacional","text":"<pre><code>                              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                              \u2502   etl_sources   \u2502\n                              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                       \u2502 1:N\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502              \u2502                   \u2502                   \u2502                  \u2502\n    \u25bc              \u25bc                   \u25bc                   \u25bc                  \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502fact_    \u2502  \u2502fact_demanda_  \u2502  \u2502fact_energia_\u2502  \u2502fact_poten- \u2502  \u2502fact_capacidad_  \u2502\n\u2502regalias \u2502  \u2502 gas_natural   \u2502  \u2502  electrica  \u2502  \u2502cia_maxima  \u2502  \u2502   instalada     \u2502\n\u2502 (ANH)   \u2502  \u2502   (UPME)      \u2502  \u2502   (UPME)    \u2502  \u2502  (UPME)    \u2502  \u2502     (UPME)      \u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502               \u2502                 \u2502               \u2502                  \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u25bc\n                       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                       \u2502  dim_tiempo  \u2502\n                       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502dim_areas_electric\u2502    \u2502  dim_campos   \u2502\u2500\u2500\u2500\u25ba\u2502dim_territorios\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502dim_resoluciones\u2502    \u2502fact_participacion_   \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502       campo          \u2502\n                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"database/esquema/#tablas-de-configuracion-etl","title":"Tablas de Configuraci\u00f3n ETL","text":""},{"location":"database/esquema/#etl_sources","title":"<code>etl_sources</code>","text":"<p>Configuraci\u00f3n maestra de cada fuente de datos.</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>text</code> PK. Identificador \u00fanico. <code>name</code> <code>text</code> Nombre legible. <code>active</code> <code>boolean</code> Activar/desactivar fuente. <code>type</code> <code>text</code> Tipo: <code>api</code>, <code>scrape</code>, <code>complex_scraper</code>. <code>schedule_cron</code> <code>text</code> Expresi\u00f3n CRON. <code>config</code> <code>jsonb</code> Configuraci\u00f3n del checker. <code>storage_config</code> <code>jsonb</code> Configuraci\u00f3n de almacenamiento."},{"location":"database/esquema/#source_check_history","title":"<code>source_check_history</code>","text":"<p>Bit\u00e1cora de ejecuciones del proceso <code>check-updates</code>.</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>bigint</code> PK. <code>source_id</code> <code>text</code> FK \u2192 <code>etl_sources.id</code>. <code>status</code> <code>enum</code> <code>no_change</code>, <code>changed</code>, <code>failed</code>. <code>checksum</code> <code>text</code> Hash MD5 del contenido. <code>metadata</code> <code>jsonb</code> Datos de la ejecuci\u00f3n."},{"location":"database/esquema/#tablas-de-dimensiones","title":"Tablas de Dimensiones","text":""},{"location":"database/esquema/#dim_tiempo","title":"<code>dim_tiempo</code>","text":"<p>Dimensi\u00f3n temporal compartida. Granularidad mensual.</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>serial</code> PK. <code>fecha</code> <code>date</code> Fecha del per\u00edodo (UNIQUE). <code>anio</code> <code>smallint</code> A\u00f1o. <code>mes</code> <code>smallint</code> Mes (1-12). <code>trimestre</code> <code>smallint</code> GENERATED. (1-4). <code>semestre</code> <code>smallint</code> GENERATED. (1-2). <code>nombre_mes</code> <code>text</code> Nombre en espa\u00f1ol. <code>es_proyeccion</code> <code>boolean</code> Dato proyectado vs hist\u00f3rico."},{"location":"database/esquema/#dim_territorios","title":"<code>dim_territorios</code>","text":"<p>Dimensi\u00f3n geogr\u00e1fica con departamentos y municipios.</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>serial</code> PK. <code>departamento</code> <code>text</code> Nombre del departamento. <code>municipio</code> <code>text</code> Nombre del municipio. <code>latitud</code> <code>numeric(10,7)</code> Coordenada. <code>longitud</code> <code>numeric(10,7)</code> Coordenada. <code>divipola</code> <code>text</code> C\u00f3digo DANE DIVIPOLA."},{"location":"database/esquema/#dim_campos","title":"<code>dim_campos</code>","text":"<p>Dimensi\u00f3n de campos petroleros/gas\u00edferos.</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>serial</code> PK. <code>nombre_campo</code> <code>text</code> Nombre del campo (UNIQUE). <code>contrato</code> <code>text</code> Contrato asociado. <code>operador</code> <code>text</code> Empresa operadora. <code>asociados</code> <code>text[]</code> Empresas asociadas. <code>participacion_estado</code> <code>numeric(5,2)</code> % participaci\u00f3n estatal. <code>territorio_id</code> <code>int</code> FK \u2192 <code>dim_territorios.id</code>. <code>activo</code> <code>boolean</code> Estado del campo."},{"location":"database/esquema/#dim_areas_electricas","title":"<code>dim_areas_electricas</code>","text":"<p>Cat\u00e1logo de \u00e1mbitos/\u00e1reas para proyecciones el\u00e9ctricas.</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>serial</code> PK. <code>codigo</code> <code>text</code> C\u00f3digo \u00fanico. <code>nombre</code> <code>text</code> Nombre del \u00e1rea. <code>categoria</code> <code>text</code> <code>nacional</code>, <code>area_sin</code>, <code>combinado</code>, <code>gd</code>, <code>proyecto</code>. <code>descripcion</code> <code>text</code> Descripci\u00f3n."},{"location":"database/esquema/#dim_resoluciones","title":"<code>dim_resoluciones</code>","text":"<p>Resoluciones MinMinas con periodos de vigencia.</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>serial</code> PK. <code>numero_resolucion</code> <code>text</code> N\u00famero de resoluci\u00f3n (UNIQUE). <code>fecha_resolucion</code> <code>date</code> Fecha de emisi\u00f3n. <code>periodo_desde</code> <code>date</code> Inicio de vigencia. <code>periodo_hasta</code> <code>date</code> Fin de vigencia. <code>url_pdf</code> <code>text</code> Enlace al PDF. <code>url_soporte_magnetico</code> <code>text</code> Enlace a anexos."},{"location":"database/esquema/#tablas-de-referencia","title":"Tablas de Referencia","text":""},{"location":"database/esquema/#ref_unidades","title":"<code>ref_unidades</code>","text":"<p>Factores de conversi\u00f3n entre unidades de medida.</p> C\u00f3digo Nombre Factor a GBTUD Descripci\u00f3n <code>GBTUD</code> Giga BTU por D\u00eda 1.0 Unidad base demanda <code>KPCD</code> Kilo Pies C\u00fabicos por D\u00eda 0.001 1 KPCD \u2248 0.001 GBTUD <code>MPCD</code> Millones Pies C\u00fabicos por D\u00eda 1.0 1 MPCD \u2248 1 GBTUD <code>BLS</code> Barriles NULL Unidad de l\u00edquidos <code>KPC</code> Kilo Pies C\u00fabicos 0.001 Volumen gas"},{"location":"database/esquema/#tablas-de-hechos","title":"Tablas de Hechos","text":""},{"location":"database/esquema/#fact_regalias","title":"<code>fact_regalias</code>","text":"<p>Fuente: API Socrata ANH (j7js-yk74)</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>bigserial</code> PK. <code>tiempo_id</code> <code>int</code> FK \u2192 <code>dim_tiempo.id</code>. <code>campo_id</code> <code>int</code> FK \u2192 <code>dim_campos.id</code>. <code>tipo_produccion</code> <code>text</code> Tipo (QB/P/B/I/QI). <code>tipo_hidrocarburo</code> <code>char(1)</code> <code>G</code>=Gas, <code>O</code>=Petr\u00f3leo. <code>precio_usd</code> <code>numeric(12,4)</code> Precio USD. <code>porcentaje_regalia</code> <code>numeric(5,2)</code> % gravable. <code>produccion_gravable</code> <code>numeric(18,4)</code> Volumen producci\u00f3n. <code>volumen_regalia</code> <code>numeric(18,4)</code> Volumen regal\u00edas. <code>valor_regalias_cop</code> <code>numeric(18,2)</code> Valor en COP."},{"location":"database/esquema/#fact_demanda_gas_natural","title":"<code>fact_demanda_gas_natural</code>","text":"<p>Fuente: UPME - Proyecci\u00f3n de Demanda Gas Natural</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>bigserial</code> PK. <code>tiempo_id</code> <code>int</code> FK \u2192 <code>dim_tiempo.id</code>. <code>periodicidad</code> <code>text</code> <code>mensual</code>, <code>anual</code>. <code>categoria</code> <code>text</code> <code>COMPRESORES</code>, <code>INDUSTRIAL</code>, <code>PETROLERO</code>, <code>PETROQUIMICO</code>, <code>RESIDENCIAL</code>, <code>TERCIARIO</code>, <code>TERMOELECTRICO</code>, <code>GNC_TRANSPORTE</code>, <code>GNL_TRANSPORTE</code>, <code>AGREGADO</code>. <code>region</code> <code>text</code> Regi\u00f3n geogr\u00e1fica. <code>nodo</code> <code>text</code> Nodo espec\u00edfico. <code>escenario</code> <code>text</code> <code>ESC_BAJO</code>, <code>ESC_MEDIO</code>, <code>ESC_ALTO</code>. <code>valor</code> <code>numeric(18,6)</code> Valor en GBTUD. <code>revision</code> <code>text</code> Etiqueta de revisi\u00f3n."},{"location":"database/esquema/#fact_energia_electrica","title":"<code>fact_energia_electrica</code>","text":"<p>Fuente: UPME - Proyecci\u00f3n de Demanda Energ\u00eda El\u00e9ctrica</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>bigserial</code> PK. <code>tiempo_id</code> <code>int</code> FK \u2192 <code>dim_tiempo.id</code>. <code>periodicidad</code> <code>text</code> <code>mensual</code>, <code>anual</code>. <code>unidad</code> <code>text</code> <code>GWh-mes</code>, <code>GWh-a\u00f1o</code>. <code>area_id</code> <code>int</code> FK \u2192 <code>dim_areas_electricas.id</code>. <code>descriptor</code> <code>text</code> Descriptor adicional. <code>escenario</code> <code>text</code> <code>ESC_BAJO</code>, <code>ESC_MEDIO</code>, <code>ESC_ALTO</code>, <code>IC_SUP_95</code>, <code>IC_INF_95</code>, <code>IC_SUP_68</code>, <code>IC_INF_68</code>. <code>revision</code> <code>text</code> Etiqueta de revisi\u00f3n. <code>valor</code> <code>numeric(18,6)</code> Valor en GWh."},{"location":"database/esquema/#fact_potencia_maxima","title":"<code>fact_potencia_maxima</code>","text":"<p>Fuente: UPME - Proyecci\u00f3n de Potencia M\u00e1xima</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>bigserial</code> PK. <code>tiempo_id</code> <code>int</code> FK \u2192 <code>dim_tiempo.id</code>. <code>periodicidad</code> <code>text</code> <code>mensual</code>, <code>anual</code>. <code>unidad</code> <code>text</code> <code>MW-mes</code>, <code>MW-a\u00f1o</code>. <code>area_id</code> <code>int</code> FK \u2192 <code>dim_areas_electricas.id</code>. <code>descriptor</code> <code>text</code> Descriptor adicional. <code>escenario</code> <code>text</code> <code>ESC_BAJO</code>, <code>ESC_MEDIO</code>, <code>ESC_ALTO</code>, <code>IC_SUP_95</code>, <code>IC_INF_95</code>, <code>IC_SUP_68</code>, <code>IC_INF_68</code>. <code>revision</code> <code>text</code> Etiqueta de revisi\u00f3n. <code>valor</code> <code>numeric(18,6)</code> Valor en MW."},{"location":"database/esquema/#fact_capacidad_instalada","title":"<code>fact_capacidad_instalada</code>","text":"<p>Fuente: UPME - Proyecci\u00f3n de Capacidad Instalada GD</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>bigserial</code> PK. <code>tiempo_id</code> <code>int</code> FK \u2192 <code>dim_tiempo.id</code>. <code>periodicidad</code> <code>text</code> <code>anual</code> (solo anual). <code>unidad</code> <code>text</code> <code>MW-a\u00f1o</code>. <code>area_id</code> <code>int</code> FK \u2192 <code>dim_areas_electricas.id</code>. <code>descriptor</code> <code>text</code> Descriptor adicional. <code>escenario</code> <code>text</code> <code>ESC_BAJO</code>, <code>ESC_MEDIO</code>, <code>ESC_ALTO</code>, <code>IC_SUP_95</code>, <code>IC_INF_95</code>, <code>IC_SUP_68</code>, <code>IC_INF_68</code>. <code>revision</code> <code>text</code> Etiqueta de revisi\u00f3n. <code>valor</code> <code>numeric(18,6)</code> Valor en MW."},{"location":"database/esquema/#fact_oferta_gas","title":"<code>fact_oferta_gas</code>","text":"<p>Fuente: MinMinas - Declaraci\u00f3n de Producci\u00f3n</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>bigserial</code> PK. <code>tiempo_id</code> <code>int</code> FK \u2192 <code>dim_tiempo.id</code>. <code>campo_id</code> <code>int</code> FK \u2192 <code>dim_campos.id</code>. <code>resolucion_id</code> <code>int</code> FK \u2192 <code>dim_resoluciones.id</code>. <code>tipo_produccion</code> <code>text</code> <code>PTDV</code>, <code>PC_CONTRATOS</code>, <code>PC_EXPORTACIONES</code>, <code>PP</code>, <code>GAS_OPERACION</code>, <code>CIDV</code>. <code>operador</code> <code>text</code> Operador. <code>es_operador_campo</code> <code>boolean</code> \u00bfEs operador principal? <code>es_participacion_estado</code> <code>boolean</code> \u00bfEs parte del Estado? <code>valor_gbtud</code> <code>numeric(18,6)</code> Valor normalizado. <code>poder_calorifico_btu_pc</code> <code>numeric(12,4)</code> BTU/PC del campo."},{"location":"database/esquema/#fact_participacion_campo","title":"<code>fact_participacion_campo</code>","text":"<p>Fuente: MinMinas - Participaci\u00f3n por resoluci\u00f3n</p> Columna Tipo Descripci\u00f3n <code>id</code> <code>bigserial</code> PK. <code>campo_id</code> <code>int</code> FK \u2192 <code>dim_campos.id</code>. <code>resolucion_id</code> <code>int</code> FK \u2192 <code>dim_resoluciones.id</code>. <code>periodo_desde</code> <code>date</code> Inicio del periodo. <code>periodo_hasta</code> <code>date</code> Fin del periodo. <code>asociado</code> <code>text</code> Empresa asociada. <code>participacion_pct</code> <code>numeric(5,2)</code> % participaci\u00f3n. <code>estado_pct</code> <code>numeric(5,2)</code> % Estado."},{"location":"database/esquema/#tipos-enumerados","title":"Tipos Enumerados","text":"<ul> <li><code>source_update_method</code>: <code>'api'</code>, <code>'scraping'</code>, <code>'html'</code>, <code>'archivo'</code>, <code>'complex_scraper'</code></li> <li><code>source_check_status</code>: <code>'no_change'</code>, <code>'changed'</code>, <code>'failed'</code></li> </ul>"},{"location":"database/esquema/#script-de-migracion","title":"Script de Migraci\u00f3n","text":"<p>Ver: init_db.sql</p>"},{"location":"guias/api_configuracion/","title":"Configuraci\u00f3n de APIs","text":"<p>El sistema soporta m\u00faltiples m\u00e9todos de autenticaci\u00f3n y optimizaciones para consultas a APIs.</p>"},{"location":"guias/api_configuracion/#variables-de-entorno","title":"Variables de Entorno","text":"<p>Cualquier valor en <code>params</code> o <code>headers</code> que comience con <code>$</code> es tratado como una variable de entorno. Esto permite mantener las credenciales seguras sin exponerlas en el c\u00f3digo.</p> <p>Sintaxis: <pre><code>\"$VARIABLE_NAME\"  \u2192 se resuelve como os.getenv(\"VARIABLE_NAME\")\n</code></pre></p> <p>Ejemplo: <pre><code>{\n  \"id\": \"api_regalias\",\n  \"type\": \"api\",\n  \"config\": {\n    \"base_url\": \"https://www.datos.gov.co/api/v3/views/j7js-yk74/query.json\",\n    \"params\": {\n      \"app_token\": \"$DATOS_GOV_TOKEN\"\n    },\n    \"headers\": {\n      \"Accept\": \"application/json\"\n    }\n  }\n}\n</code></pre></p> <p>En el archivo <code>.env</code>: <pre><code>DATOS_GOV_TOKEN=tu_token_aqui\n</code></pre></p>"},{"location":"guias/api_configuracion/#tipos-de-autenticacion","title":"Tipos de Autenticaci\u00f3n","text":"<p>El par\u00e1metro <code>auth_type</code> en <code>config</code> especifica el m\u00e9todo de autenticaci\u00f3n. La credencial se define mediante <code>auth_key_env</code> (nombre de la variable de entorno).</p> auth_type Descripci\u00f3n Ejemplo <code>bearer</code> Agrega header <code>Authorization: Bearer {token}</code> OAuth 2.0, APIs modernas <code>api_key</code> Agrega header <code>X-API-Key: {token}</code> APIs que usan API Keys <code>custom_header</code> Permite especificar el nombre del header Cualquier header personalizado <p>Ejemplo con Bearer Token: <pre><code>{\n  \"id\": \"api_ejemplo\",\n  \"type\": \"api\",\n  \"config\": {\n    \"base_url\": \"https://api.ejemplo.com/data\",\n    \"auth_type\": \"bearer\",\n    \"auth_key_env\": \"API_EJEMPLO_TOKEN\",\n    \"headers\": { \"Accept\": \"application/json\" }\n  }\n}\n</code></pre></p> <p>En <code>.env</code>: <pre><code>API_EJEMPLO_TOKEN=sk_live_xxxxx\n</code></pre></p>"},{"location":"guias/api_configuracion/#deteccion-eficiente-de-cambios-apis-socrata","title":"Detecci\u00f3n Eficiente de Cambios (APIs Socrata)","text":"<p>Para APIs que retornan grandes vol\u00famenes de datos (ej. 200K+ registros), es ineficiente descargar todo para detectar cambios. Socrata y plataformas similares exponen un endpoint de metadata mucho m\u00e1s ligero.</p>"},{"location":"guias/api_configuracion/#parametros-especiales","title":"Par\u00e1metros especiales","text":"Par\u00e1metro Descripci\u00f3n Ejemplo <code>check_endpoint</code> Endpoint de metadata (sin datos) <code>https://datos.gov.co/api/views/{id}.json</code> <code>check_field</code> Campo en la metadata que indica cambios <code>rowsUpdatedAt</code>, <code>lastUpdateTime</code>"},{"location":"guias/api_configuracion/#flujo-optimizado","title":"Flujo optimizado","text":"<ol> <li>Check \u2192 Consulta solo metadata (~5KB)</li> <li>Compara el campo <code>check_field</code> con la ejecuci\u00f3n anterior</li> <li>Si cambi\u00f3 \u2192 Ejecuta Full ETL y descarga los datos</li> <li>Si no cambi\u00f3 \u2192 Omite la descarga (ahorro de ancho de banda)</li> </ol>"},{"location":"guias/api_configuracion/#ejemplo-de-configuracion","title":"Ejemplo de Configuraci\u00f3n","text":"<pre><code>{\n  \"id\": \"api_regalias\",\n  \"type\": \"api\",\n  \"config\": {\n    \"base_url\": \"https://www.datos.gov.co/api/v3/views/j7js-yk74/query.json\",\n    \"check_endpoint\": \"https://www.datos.gov.co/api/views/j7js-yk74.json\",\n    \"check_field\": \"rowsUpdatedAt\",\n    \"params\": {\n      \"app_token\": \"$DATOS_GOV_TOKEN\"\n    },\n    \"headers\": {\n      \"Accept\": \"application/json\"\n    }\n  }\n}\n</code></pre>"},{"location":"guias/api_configuracion/#paginacion-de-datos-extensos","title":"Paginaci\u00f3n de Datos Extensos","text":"<p>Para APIs que retornan muy grandes vol\u00famenes de datos (ej. 500K+ registros), el sistema soporta descarga paginada autom\u00e1tica. Cada p\u00e1gina se guarda en un archivo separado para evitar timeouts y saturaci\u00f3n de memoria.</p>"},{"location":"guias/api_configuracion/#cuando-usar-paginacion","title":"Cu\u00e1ndo usar paginaci\u00f3n","text":"<ul> <li>Dataset &gt; 100K registros</li> <li>API soporta par\u00e1metros de paginaci\u00f3n</li> <li>Necesitas descarga robusta y recuperable por p\u00e1ginas</li> </ul>"},{"location":"guias/api_configuracion/#tipos-de-paginacion-soportados","title":"Tipos de Paginaci\u00f3n Soportados","text":""},{"location":"guias/api_configuracion/#1-page-based-socrata-muchas-apis-modernas","title":"1. Page-based (Socrata, muchas APIs modernas)","text":"<p>Usa <code>pageNumber</code> y <code>pageSize</code></p> <pre><code>{\n  \"pagination\": {\n    \"enabled\": true,\n    \"page_param\": \"pageNumber\",\n    \"size_param\": \"pageSize\",\n    \"page_size\": 10000\n  }\n}\n</code></pre> <p>URL generada: <pre><code>https://api.datos.gov.co/data?pageNumber=1&amp;pageSize=10000&amp;app_token=XXX\nhttps://api.datos.gov.co/data?pageNumber=2&amp;pageSize=10000&amp;app_token=XXX\n...\n</code></pre></p>"},{"location":"guias/api_configuracion/#2-offset-based-apis-antiguas-soap","title":"2. Offset-based (APIs antiguas, SOAP)","text":"<p>Usa <code>$offset</code> y <code>$limit</code></p> <pre><code>{\n  \"pagination\": {\n    \"enabled\": true,\n    \"offset_param\": \"$offset\",\n    \"limit_param\": \"$limit\",\n    \"page_size\": 50000\n  }\n}\n</code></pre>"},{"location":"guias/api_configuracion/#estructura-de-almacenamiento","title":"Estructura de Almacenamiento","text":"<p>Cuando se habilita paginaci\u00f3n, los datos se guardan as\u00ed:</p> <pre><code>raw-data/api/api_regalias/2025-11-24_183107/\n\u251c\u2500\u2500 page_0001.json  (10K registros)\n\u251c\u2500\u2500 page_0002.json  (10K registros)\n\u251c\u2500\u2500 page_0003.json  (10K registros)\n\u2514\u2500\u2500 ...\n</code></pre>"},{"location":"guias/api_configuracion/#ejemplo-completo-socrata","title":"Ejemplo Completo: Socrata","text":"<pre><code>{\n  \"id\": \"api_regalias\",\n  \"name\": \"Consolidaci\u00f3n de regalias por campo\",\n  \"type\": \"api\",\n  \"active\": true,\n  \"schedule\": { \"cron\": \"0 * * * *\", \"note\": \"Every hour\" },\n  \"config\": {\n    \"base_url\": \"https://www.datos.gov.co/api/v3/views/j7js-yk74/query.json\",\n    \"check_endpoint\": \"https://www.datos.gov.co/api/views/j7js-yk74.json\",\n    \"check_field\": \"rowsUpdatedAt\",\n    \"params\": { \"app_token\": \"$DATOS_GOV_TOKEN\" },\n    \"headers\": { \"Accept\": \"application/json\" },\n    \"timeout\": 120,\n    \"pagination\": {\n      \"enabled\": true,\n      \"page_param\": \"pageNumber\",\n      \"size_param\": \"pageSize\",\n      \"page_size\": 10000\n    }\n  },\n  \"storage\": { \"bucket\": \"raw-data\" }\n}\n</code></pre>"},{"location":"guias/api_configuracion/#monitoreo-de-paginacion","title":"Monitoreo de Paginaci\u00f3n","text":"<p>Los logs mostrar\u00e1n el progreso:</p> <pre><code>[api_loader] Descargando p\u00e1gina 1 (pageNumber=1, pageSize=10000)\n[api_loader] P\u00e1gina 1 guardada: api/api_regalias/2025-11-24_183107/page_0001.json\n[api_loader] Descargando p\u00e1gina 2 (pageNumber=2, pageSize=10000)\n[api_loader] P\u00e1gina 2 guardada: api/api_regalias/2025-11-24_183107/page_0002.json\n...\n[api_loader] \u00daltima p\u00e1gina detectada (solo 5432 filas &lt; 10000)\n[api_loader] Paginaci\u00f3n completada: 15 p\u00e1ginas, 145432 filas totales\n</code></pre>"},{"location":"guias/api_configuracion/#configuracion-avanzada","title":"Configuraci\u00f3n Avanzada","text":"Par\u00e1metro Descripci\u00f3n Valor por defecto <code>timeout</code> Tiempo m\u00e1ximo de respuesta en segundos <code>60</code> <code>max_retries</code> N\u00famero de reintentos ante fallos <code>3</code> <p>Ejemplo: <pre><code>{\n  \"config\": {\n    \"base_url\": \"https://api.ejemplo.com/data\",\n    \"timeout\": 30,\n    \"max_retries\": 5,\n    \"auth_type\": \"bearer\",\n    \"auth_key_env\": \"API_TOKEN\"\n  }\n}\n</code></pre></p>"},{"location":"guias/api_transformer_extension/","title":"Extender ApiTransformer - Gu\u00eda R\u00e1pida","text":"<p>ApiTransformer es gen\u00e9rico y parametrizado. Para soportar una nueva API Socrata, solo necesitas:</p> <ol> <li>Definir configuraci\u00f3n en <code>config.py</code></li> <li>Registrar en <code>CONFIG_REGISTRY</code></li> <li>Usar sin cambios de c\u00f3digo</li> </ol>"},{"location":"guias/api_transformer_extension/#paso-1-crear-transformationconfig","title":"Paso 1: Crear TransformationConfig","text":"<p>En <code>data/workflows/full_etl/transformers/config.py</code>:</p> <pre><code>from datetime import date\n\n# Ejemplo: Nueva API de Oferta de Gas\n\ndef _derive_fecha_oferta(row):\n    \"\"\"Derivar fecha primer d\u00eda del mes para oferta.\"\"\"\n    return date(int(row[\"anio\"]), int(row[\"mes\"]), 1)\n\ndef _validate_oferta_coherencia(record: Dict[str, Any]) -&gt; Optional[str]:\n    \"\"\"Validar l\u00f3gica espec\u00edfica de oferta.\"\"\"\n    # Ejemplo: producci\u00f3n &gt;= reservas\n    if record.get(\"produccion\", 0) &lt; record.get(\"reservas\", 0):\n        return \"Producci\u00f3n menor que reservas\"\n    return None\n\nOFERTA_CONFIG = TransformationConfig(\n    source_id=\"api_oferta\",\n    description=\"ANH - Oferta de Gas (Socrata)\",\n    data_path=\"data\",\n\n    column_validations=[\n        ColumnValidation(\"mes\", ValidationRule.RANGE, \n                        \"Mes fuera de rango (1-12)\",\n                        params={\"min\": 1, \"max\": 12}),\n        ColumnValidation(\"produccion\", ValidationRule.NON_NEGATIVE, \n                        \"Producci\u00f3n negativa\"),\n        ColumnValidation(\"tipo_recurso\", ValidationRule.ENUM, \n                        \"Tipo recurso inv\u00e1lido\",\n                        params={\"values\": [\"GN\", \"GC\", \"CR\"]}),\n    ],\n\n    column_derivations=[\n        ColumnDerivation(\n            target_column=\"fecha_derivada\",\n            source_columns=[\"anio\", \"mes\"],\n            function=_derive_fecha_oferta,\n            description=\"Derivar fecha primer d\u00eda del mes\"\n        ),\n    ],\n\n    fact_mapping=FactTableMapping(\n        fact_table=\"fact_demanda_gas_natural\",\n        column_mapping={\n            \"fecha\": \"fecha_derivada\",\n            \"categoria\": \"categoria\",\n            \"region\": \"region\",\n            \"nodo\": \"nodo\",\n            \"escenario\": \"escenario\",\n            \"valor\": \"valor\",\n            \"revision\": \"revision\",\n        },\n        dimension_mappings=[\n            DimensionMapping(\n                dimension_name=\"tiempo\",\n                column_mapping={\n                    \"fecha\": \"fecha_derivada\",\n                    \"anio\": \"anio\",\n                    \"mes\": \"mes\",\n                    \"es_proyeccion\": True,\n                }\n            ),\n            # Agregar m\u00e1s dimensiones seg\u00fan necesidad\n        ],\n        description=\"Fact table de demanda gas natural\"\n    ),\n\n    custom_validator=_validate_oferta_coherencia,\n)\n</code></pre>"},{"location":"guias/api_transformer_extension/#paso-2-registrar-la-configuracion","title":"Paso 2: Registrar la Configuraci\u00f3n","text":"<pre><code># Al final de config.py\n\nCONFIG_REGISTRY[\"api_oferta\"] = OFERTA_CONFIG\n\n# O usar funci\u00f3n helper\nregister_transformation_config(OFERTA_CONFIG)\n</code></pre>"},{"location":"guias/api_transformer_extension/#paso-3-usar-sin-cambios-de-codigo","title":"Paso 3: Usar sin cambios de c\u00f3digo","text":"<pre><code>from workflows.full_etl.transformers import ApiTransformer\n\ntransformer = ApiTransformer()\n\n# ApiTransformer autom\u00e1ticamente busca \"api_oferta\" en CONFIG_REGISTRY\nresult = transformer.transform(\n    raw_data=json_data_string,\n    source_config={\"id\": \"api_oferta\"}\n)\n\n# result = {\n#     \"valid_records\": [...],\n#     \"errors\": [...],\n#     \"stats\": {...}\n# }\n</code></pre>"},{"location":"guias/api_transformer_extension/#tipos-de-validacion-disponibles","title":"Tipos de Validaci\u00f3n Disponibles","text":"Tipo Par\u00e1metros Ejemplo <code>RANGE</code> <code>min</code>, <code>max</code> Mes 1-12 <code>ENUM</code> <code>values</code> (list) Tipo: [\"G\", \"O\"] <code>NON_NEGATIVE</code> - Precio &gt;= 0 <code>BETWEEN_0_100</code> - Porcentaje 0-100 <code>POSITIVE</code> - Cantidad &gt; 0 <code>NOT_NULL</code> - Campo obligatorio <code>DATE_VALID</code> - Fecha v\u00e1lida"},{"location":"guias/api_transformer_extension/#derivaciones-parametrizadas","title":"Derivaciones Parametrizadas","text":"<pre><code>ColumnDerivation(\n    target_column=\"new_column\",\n    source_columns=[\"col1\", \"col2\"],  # Pasadas a function\n    function=lambda row: row[\"col1\"] * row[\"col2\"],  # O funci\u00f3n custom\n    description=\"Multiplicaci\u00f3n de columnas\"\n)\n</code></pre>"},{"location":"guias/api_transformer_extension/#custom-validator-logica-compleja","title":"Custom Validator (L\u00f3gica compleja)","text":"<pre><code>def _my_custom_validator(record: Dict[str, Any]) -&gt; Optional[str]:\n    \"\"\"\n    Validaci\u00f3n cross-columna despu\u00e9s de mapeo.\n\n    Args:\n        record: Dict con datos mapeados\n\n    Returns:\n        None si v\u00e1lido, string con mensaje de error si inv\u00e1lido\n    \"\"\"\n    # Ejemplo: validar relaciones entre campos\n    if record[\"produccion\"] &gt; record[\"capacidad\"]:\n        return \"Producci\u00f3n excede capacidad\"\n\n    # Validar rango de fechas\n    if record[\"fecha\"] &lt; date(2020, 1, 1):\n        return \"Fecha anterior a 2020\"\n\n    return None  # \u2705 V\u00e1lido\n</code></pre> <p>Asignar en config: <pre><code>fact_mapping=FactTableMapping(...),\ncustom_validator=_my_custom_validator,\n</code></pre></p>"},{"location":"guias/api_transformer_extension/#custom-transformer-transformacion-especial","title":"Custom Transformer (Transformaci\u00f3n especial)","text":"<pre><code>def _my_custom_transformer(row: Dict[str, Any], source_id: str) -&gt; Dict[str, Any]:\n    \"\"\"\n    Transformaci\u00f3n custom si las reglas no son suficientes.\n\n    Args:\n        row: DataFrame row como dict\n        source_id: ID de la fuente\n\n    Returns:\n        {\"fact_table\": \"...\", \"data\": {...}, \"dimensions\": {...}}\n    \"\"\"\n    return {\n        \"fact_table\": \"fact_custom\",\n        \"data\": {\n            \"campo1\": row[\"col1\"],\n            \"campo2\": row[\"col2\"] * 2,  # Transformaci\u00f3n custom\n        },\n        \"dimensions\": {\n            \"tiempo\": {...}\n        }\n    }\n</code></pre> <p>Asignar en config: <pre><code>custom_transformer=_my_custom_transformer,\n</code></pre></p>"},{"location":"guias/api_transformer_extension/#checklist-para-nueva-fuente","title":"Checklist para Nueva Fuente","text":"<ul> <li>[ ] Definir <code>TransformationConfig</code> en <code>config.py</code></li> <li>[ ] Listar todas las validaciones necesarias</li> <li>[ ] Derivar columnas si aplica</li> <li>[ ] Mapear fact table + dimensiones</li> <li>[ ] Agregar custom_validator si hay l\u00f3gica cross-columna</li> <li>[ ] Registrar en <code>CONFIG_REGISTRY</code></li> <li>[ ] Probar: <code>transformer.transform(data, {\"id\": \"api_nuevo\"})</code></li> <li>[ ] Documentar en tabla de fuentes</li> </ul>"},{"location":"guias/api_transformer_extension/#troubleshooting","title":"Troubleshooting","text":"<p>Error: \"No hay TransformationConfig para {source_id}\" - Verificar que <code>source_id</code> est\u00e9 registrado en <code>CONFIG_REGISTRY</code> - Confirmar nombre exacto (sensible a may\u00fasculas)</p> <p>Errores en validaci\u00f3n vectorizada - Verificar nombres de columnas en <code>column_validations</code> - Confirmar que columnas existen en JSON original</p> <p>Derivaciones fallan - Validar que <code>source_columns</code> existen en DataFrame - Probar funci\u00f3n lambda en aislamiento primero</p>"},{"location":"guias/api_transformer_extension/#arquitectura-general","title":"Arquitectura General","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   ApiTransformer.transform()                    \u2502\n\u2502                 (Gen\u00e9rico y dirigido por config)                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                                         \u2502\n        \u25bc                                         \u25bc\n  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510               \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502 source_config    \u2502               \u2502 get_transformation   \u2502\n  \u2502 {\"id\": \"api_X\"}  \u2502               \u2502 _config(source_id)   \u2502\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518               \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n           \u2502                                    \u2502\n           \u2502                                    \u25bc\n           \u2502                         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n           \u2502                         \u2502   CONFIG_REGISTRY   \u2502\n           \u2502                         \u2502  (Dict[str-&gt;config])\u2502\n           \u2502                         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n           \u2502                                  \u2502\n           \u2502                 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n           \u2502                 \u2502                \u2502                \u2502\n           \u2502                 \u25bc                \u25bc                \u25bc\n           \u2502          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n           \u2502          \u2502 REGALIAS_   \u2502 \u2502 TEMPLATE_   \u2502 \u2502   CUSTOM     \u2502\n           \u2502          \u2502 CONFIG      \u2502 \u2502 SOCRATA_    \u2502 \u2502   CONFIGS    \u2502\n           \u2502          \u2502 (instancia) \u2502 \u2502 CONFIG      \u2502 \u2502              \u2502\n           \u2502          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n           \u2502\n           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                                                      \u2502\n                \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                \u2502\n                \u25bc\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 TRANSFORMATION PIPELINE          \u2502\n    \u2502 (7 pasos coherentes)             \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                   \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                     \u2502\n        \u25bc                     \u25bc\n   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502 JSON Parsing\u2502    \u2502 Extract Records\u2502\n   \u2502  (orjson)   \u2502    \u2502 from config    \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502                    \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n                     \u25bc\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502 Load DataFrame         \u2502\n          \u2502 (Vectorized ops ready) \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                       \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                             \u2502\n        \u25bc                             \u25bc\n   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502 Pre-Validations \u2502        \u2502 Column Derivations\u2502\n   \u2502 (Vectorized)    \u2502        \u2502 (from config)    \u2502\n   \u2502 Via ValidationRule\u2502       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2502\n            \u2502                       \u2502\n            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                        \u2502\n                        \u25bc\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502 Mapping &amp; Final Assembly   \u2502\n          \u2502 (Via FactTableMapping)     \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                       \u2502\n                       \u25bc\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502 Return Transform Result    \u2502\n          \u2502 {valid, errors, stats}     \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"guias/configuracion_fuentes/","title":"Gu\u00eda de Configuraci\u00f3n de Fuentes","text":"<p>Esta gu\u00eda proporciona una introducci\u00f3n a c\u00f3mo configurar diferentes tipos de fuentes de datos en el sistema ETL.</p>"},{"location":"guias/configuracion_fuentes/#tipos-de-fuentes-soportadas","title":"Tipos de Fuentes Soportadas","text":"Tipo Descripci\u00f3n Complejidad Ejemplo <code>api</code> Consume datos directamente de una API REST Baja API de datos p\u00fablicos, Socrata <code>web</code> Descarga HTML de un sitio web Baja Web scraping b\u00e1sico <code>complex_scraper</code> L\u00f3gica personalizada con Selenium/Playwright Alta Navegaci\u00f3n interactiva, JS renderizado"},{"location":"guias/configuracion_fuentes/#guias-especificas","title":"Gu\u00edas Espec\u00edficas","text":"<p>Para detalles completos sobre cada tipo de configuraci\u00f3n, consulta:</p> <ul> <li>Configuraci\u00f3n de Storage - D\u00f3nde se guardan los datos</li> <li>Configuraci\u00f3n de APIs - C\u00f3mo consumir APIs REST</li> <li>Scripts Personalizados - Implementar l\u00f3gica compleja</li> </ul>"},{"location":"guias/configuracion_fuentes/#estructura-basica-de-una-fuente","title":"Estructura B\u00e1sica de una Fuente","text":"<pre><code>{\n  \"id\": \"mi_fuente\",\n  \"name\": \"Mi Fuente de Datos\",\n  \"active\": true,\n  \"type\": \"api\",\n  \"schedule\": { \"cron\": \"0 9 * * *\", \"note\": \"Daily at 9 AM\" },\n  \"config\": {\n    // Configuraci\u00f3n espec\u00edfica del tipo\n  },\n  \"storage\": {\n    \"bucket\": \"raw-data\"\n  }\n}\n</code></pre>"},{"location":"guias/configuracion_fuentes/#parametros-comunes","title":"Par\u00e1metros Comunes","text":"Par\u00e1metro Descripci\u00f3n Requerido <code>id</code> Identificador \u00fanico de la fuente S\u00ed <code>name</code> Nombre descriptivo No <code>active</code> Si debe ejecutarse S\u00ed <code>type</code> Tipo de fuente: <code>api</code>, <code>web</code>, <code>complex_scraper</code> S\u00ed <code>schedule</code> Cron de ejecuci\u00f3n S\u00ed <code>config</code> Configuraci\u00f3n espec\u00edfica del tipo S\u00ed <code>storage</code> D\u00f3nde guardar los datos S\u00ed"},{"location":"guias/configuracion_fuentes/#formatos-de-schedule-cron","title":"Formatos de Schedule (cron)","text":"<pre><code>\"schedule\": { \n  \"cron\": \"0 9 * * *\",\n  \"note\": \"Daily at 9 AM\"\n}\n</code></pre> <p>Ejemplos comunes: - <code>\"* * * * *\"</code> - Cada minuto - <code>\"0 * * * *\"</code> - Cada hora - <code>\"0 9 * * *\"</code> - Cada d\u00eda a las 9 AM - <code>\"0 0 * * 1\"</code> - Cada lunes a medianoche - <code>\"*/30 * * * *\"</code> - Cada 30 minutos</p>"},{"location":"guias/configuracion_fuentes/#flujo-de-ejecucion","title":"Flujo de Ejecuci\u00f3n","text":""},{"location":"guias/configuracion_fuentes/#1-scheduler","title":"1. Scheduler","text":"<p>El APScheduler ejecuta seg\u00fan el cron definido.</p>"},{"location":"guias/configuracion_fuentes/#2-check-updates-deteccion-de-cambios","title":"2. Check Updates (Detecci\u00f3n de Cambios)","text":"<ul> <li>Resuelve variables de entorno</li> <li>Consulta estado actual (metadata o datos)</li> <li>Calcula hash SHA256</li> <li>Compara con \u00faltima ejecuci\u00f3n</li> </ul>"},{"location":"guias/configuracion_fuentes/#3-decision","title":"3. Decisi\u00f3n","text":"<ul> <li>Cambios detectados \u2192 Ejecuta Full ETL</li> <li>Sin cambios \u2192 Omite descarga</li> </ul>"},{"location":"guias/configuracion_fuentes/#4-full-etl-si-hay-cambios","title":"4. Full ETL (Si hay cambios)","text":"<ul> <li>Resuelve variables de entorno</li> <li>Descarga/procesa datos</li> <li>Genera ruta con timestamp</li> <li>Sube archivo a Supabase Storage</li> </ul>"},{"location":"guias/configuracion_fuentes/#5-registro-en-base-de-datos","title":"5. Registro en Base de Datos","text":"<ul> <li><code>etl_sources</code>: estado y \u00faltima verificaci\u00f3n</li> <li><code>source_check_history</code>: historial de cada ejecuci\u00f3n</li> </ul>"},{"location":"guias/configuracion_fuentes/#mejores-practicas","title":"Mejores Pr\u00e1cticas","text":"<ul> <li>Mant\u00e9n credenciales en <code>.env</code>, nunca en config</li> <li>Usa <code>$VARIABLE</code> para referencias a variables de entorno</li> <li>Aprovecha <code>check_endpoint</code> para APIs grandes (reduce transferencia)</li> <li>Define schedules apropiados (no sobrecargar servicios)</li> <li>Registra cambios en Git, no datos descargados</li> <li>Nunca commitees <code>.env</code> con credenciales reales</li> </ul>"},{"location":"guias/configuracion_fuentes/#ejemplos-completos","title":"Ejemplos Completos","text":""},{"location":"guias/configuracion_fuentes/#ejemplo-1-api-simple","title":"Ejemplo 1: API Simple","text":"<pre><code>{\n  \"id\": \"api_gas\",\n  \"name\": \"API Gas Colombia\",\n  \"active\": true,\n  \"type\": \"api\",\n  \"schedule\": { \"cron\": \"0 * * * *\" },\n  \"config\": {\n    \"base_url\": \"https://httpbin.org/json\"\n  },\n  \"storage\": { \"bucket\": \"raw-data\" }\n}\n</code></pre>"},{"location":"guias/configuracion_fuentes/#ejemplo-2-api-con-autenticacion","title":"Ejemplo 2: API con Autenticaci\u00f3n","text":"<pre><code>{\n  \"id\": \"api_regalias\",\n  \"name\": \"Consolidaci\u00f3n de regalias\",\n  \"active\": true,\n  \"type\": \"api\",\n  \"schedule\": { \"cron\": \"0 9 * * *\" },\n  \"config\": {\n    \"base_url\": \"https://www.datos.gov.co/api/v3/views/j7js-yk74/query.json\",\n    \"check_endpoint\": \"https://www.datos.gov.co/api/views/j7js-yk74.json\",\n    \"check_field\": \"rowsUpdatedAt\",\n    \"params\": { \"app_token\": \"$DATOS_GOV_TOKEN\" },\n    \"headers\": { \"Accept\": \"application/json\" }\n  },\n  \"storage\": { \"bucket\": \"raw-data\" }\n}\n</code></pre>"},{"location":"guias/configuracion_fuentes/#ejemplo-3-web-scraping","title":"Ejemplo 3: Web Scraping","text":"<pre><code>{\n  \"id\": \"scrape_example\",\n  \"name\": \"Scrape Example\",\n  \"active\": true,\n  \"type\": \"web\",\n  \"schedule\": { \"cron\": \"0 12 * * *\" },\n  \"config\": { \"url\": \"https://example.com\" },\n  \"storage\": { \"bucket\": \"raw-data\" }\n}\n</code></pre>"},{"location":"guias/configuracion_fuentes/#ejemplo-4-script-personalizado","title":"Ejemplo 4: Script Personalizado","text":"<pre><code>{\n  \"id\": \"banco_central\",\n  \"name\": \"Banco Central Bot\",\n  \"active\": true,\n  \"type\": \"complex_scraper\",\n  \"schedule\": { \"cron\": \"0 9 * * *\" },\n  \"config\": { \"script_name\": \"bot_banco_central\" },\n  \"storage\": { \"bucket\": \"raw-data\" }\n}\n</code></pre>"},{"location":"guias/configuracion_fuentes/#archivos-de-referencia","title":"Archivos de Referencia","text":"<ul> <li><code>data/workflows/sources_config.json</code> - Configuraci\u00f3n de ejemplo</li> <li><code>data/extraction/scrapers/</code> - Ubicaci\u00f3n de scripts personalizados</li> <li><code>declaracion/</code> - Scrapers MinMinas</li> <li><code>proyeccion/</code> - Scrapers UPME (con esquemas SQL por m\u00e9trica)</li> <li><code>docs/database/esquema.md</code> - Esquema de base de datos</li> </ul>"},{"location":"guias/scripts_personalizados/","title":"Configuraci\u00f3n de Scripts Personalizados","text":"<p>Para fuentes que requieren l\u00f3gica de extracci\u00f3n compleja (Selenium, Playwright, pasos m\u00faltiples), se utiliza el tipo <code>complex_scraper</code>.</p>"},{"location":"guias/scripts_personalizados/#vinculacion-del-script","title":"Vinculaci\u00f3n del Script","text":"<p>El sistema busca un script de Python en la carpeta <code>data/extraction/scrapers/</code>. Por defecto, busca un archivo con el mismo nombre que el <code>id</code> de la fuente.</p> <p>Para usar un nombre de archivo diferente, se utiliza el par\u00e1metro <code>script_name</code> dentro de <code>config</code>.</p>"},{"location":"guias/scripts_personalizados/#ejemplo-basico","title":"Ejemplo B\u00e1sico","text":"<pre><code>{\n  \"id\": \"banco_central_trm\",\n  \"type\": \"complex_scraper\",\n  \"schedule\": { \"cron\": \"0 9 * * *\" },\n  \"config\": {\n    \"script_name\": \"bot_banco_central\"\n  },\n  \"storage\": {\n    \"bucket\": \"raw-data\"\n  }\n}\n</code></pre> <p>En este ejemplo: - El sistema buscar\u00e1 <code>data/extraction/scrapers/bot_banco_central.py</code> - Ejecutar\u00e1 la funci\u00f3n <code>check(config)</code> durante la detecci\u00f3n de cambios - Ejecutar\u00e1 la funci\u00f3n <code>extract(config)</code> durante la descarga</p>"},{"location":"guias/scripts_personalizados/#estructura-del-script-personalizado","title":"Estructura del Script Personalizado","text":"<p>El script debe implementar dos funciones:</p>"},{"location":"guias/scripts_personalizados/#funcion-checkconfig","title":"Funci\u00f3n <code>check(config)</code>","text":"<p>Realiza la detecci\u00f3n de cambios. Debe retornar un valor hasheable (string, n\u00famero, etc).</p> <pre><code>def check(source_config: Dict[str, Any]) -&gt; str:\n    \"\"\"\n    Detecta cambios en la fuente.\n    Retorna un valor que ser\u00e1 hasheado para comparar con ejecuciones anteriores.\n\n    Ejemplos:\n    - Timestamp del \u00faltimo cambio\n    - Hash de contenido visible\n    - N\u00famero de elementos en la p\u00e1gina\n    \"\"\"\n    # Usar Selenium/Playwright para obtener informaci\u00f3n\n    # ...\n    return f\"estado_actual_{timestamp}\"\n</code></pre>"},{"location":"guias/scripts_personalizados/#funcion-extractconfig","title":"Funci\u00f3n <code>extract(config)</code>","text":"<p>Realiza la extracci\u00f3n de datos. Debe retornar bytes o string con el contenido.</p> <pre><code>def extract(source_config: Dict[str, Any]) -&gt; bytes:\n    \"\"\"\n    Descarga y procesa los datos.\n    Retorna el contenido a guardar en Storage.\n    \"\"\"\n    # Usar Selenium/Playwright para descargar/procesar datos\n    # ...\n    return contenido_procesado.encode('utf-8')\n</code></pre>"},{"location":"guias/scripts_personalizados/#ejemplo-real-bot-del-banco-central","title":"Ejemplo Real: Bot del Banco Central","text":"<pre><code># data/extraction/scrapers/bot_banco_central.py\n\nfrom typing import Dict, Any\nfrom datetime import datetime\nfrom selenium import webdriver\nfrom selenium.webdriver.common.by import By\n\ndef check(source_config: Dict[str, Any]) -&gt; str:\n    \"\"\"Detecta si hubo cambios en la tasa representativa del mercado.\"\"\"\n    driver = webdriver.Chrome()\n    try:\n        driver.get(\"https://www.bancocentral.gov.co/tasas\")\n\n        # Extrae el timestamp de \u00faltima actualizaci\u00f3n\n        update_element = driver.find_element(By.CLASS_NAME, \"last-update\")\n        last_update = update_element.text\n\n        return last_update\n    finally:\n        driver.quit()\n\ndef extract(source_config: Dict[str, Any]) -&gt; bytes:\n    \"\"\"Descarga la tasa actual.\"\"\"\n    driver = webdriver.Chrome()\n    try:\n        driver.get(\"https://www.bancocentral.gov.co/tasas\")\n\n        # Espera a que cargue la tasa\n        rate_element = driver.find_element(By.ID, \"current-rate\")\n        rate = rate_element.text\n\n        # Procesa y retorna\n        data = f\"TRM: {rate} - {datetime.now().isoformat()}\"\n        return data.encode('utf-8')\n    finally:\n        driver.quit()\n</code></pre>"},{"location":"guias/scripts_personalizados/#variables-de-entorno-en-scripts","title":"Variables de Entorno en Scripts","text":"<p>Tambi\u00e9n puedes usar variables de entorno dentro de scripts personalizados:</p> <pre><code>import os\nfrom common.env_resolver import resolve_env_var\n\ndef check(source_config: Dict[str, Any]) -&gt; str:\n    # Resuelve variable de entorno\n    api_token = resolve_env_var(\"$MY_SECRET_TOKEN\")\n\n    # O acceso directo\n    api_token = os.getenv(\"MY_SECRET_TOKEN\")\n\n    # ... resto del c\u00f3digo\n</code></pre>"},{"location":"guias/scripts_personalizados/#recomendaciones","title":"Recomendaciones","text":"<ul> <li>Usa try/finally para cerrar drivers (Selenium/Playwright)</li> <li>Implementa timeouts en las b\u00fasquedas de elementos</li> <li>Registra errores con el logger</li> </ul>"},{"location":"guias/scripts_personalizados/#depuracion-local","title":"Depuraci\u00f3n Local","text":"<p>Para probar tu script sin el scheduler:</p> <pre><code># test_bot_banco_central.py\nfrom extraction.scrapers.bot_banco_central import check, extract\n\nconfig = {\n    \"id\": \"banco_central_trm\",\n    \"config\": {}\n}\n\n# Prueba check\nprint(\"Check:\", check(config))\n\n# Prueba extract\nprint(\"Extract:\", extract(config))\n</code></pre>"},{"location":"guias/storage_configuracion/","title":"Configuraci\u00f3n de Storage","text":"<p>El sistema utiliza Supabase Storage para almacenar la data cruda (RAW) extra\u00edda de las diferentes fuentes.</p>"},{"location":"guias/storage_configuracion/#creacion-del-bucket","title":"Creaci\u00f3n del Bucket","text":"<p>Para que el sistema funcione correctamente, se debe crear un bucket en el proyecto de Supabase con las siguientes caracter\u00edsticas:</p> <ul> <li>Nombre del Bucket: <code>raw-data</code></li> <li>Acceso: Privado (recomendado) o P\u00fablico.</li> </ul>"},{"location":"guias/storage_configuracion/#estructura-de-archivos","title":"Estructura de Archivos","text":"<p>El sistema organiza autom\u00e1ticamente los archivos descargados para mantener un historial ordenado cronol\u00f3gicamente.</p>"},{"location":"guias/storage_configuracion/#apis-sin-paginacion","title":"APIs sin Paginaci\u00f3n","text":"<p>Estructura simple con un archivo por descarga:</p> <pre><code>{tipo_fuente}/{id_fuente}/{YYYY-MM-DD_HHMMSS}.{ext}\n</code></pre> <p>Ejemplos: *   <code>api/api_gas/2025-11-24_103000.json</code> *   <code>web/noticias_col/2025-11-24_154500.html</code> *   <code>complex/banco_central/2025-11-24_090000.bin</code></p>"},{"location":"guias/storage_configuracion/#apis-con-paginacion-datos-extensos","title":"APIs con Paginaci\u00f3n (Datos Extensos)","text":"<p>Cuando la fuente retorna muchos registros (100K+), el sistema descarga en p\u00e1ginas individuales:</p> <pre><code>{tipo_fuente}/{id_fuente}/{YYYY-MM-DD_HHMMSS}/\n\u251c\u2500\u2500 page_0001.json\n\u251c\u2500\u2500 page_0002.json\n\u251c\u2500\u2500 page_0003.json\n\u2514\u2500\u2500 ...\n</code></pre> <p>Ejemplo: *   <code>api/api_regalias/2025-11-24_183107/page_0001.json</code> (10K registros) *   <code>api/api_regalias/2025-11-24_183107/page_0002.json</code> (10K registros) *   <code>api/api_regalias/2025-11-24_183107/page_0003.json</code> (10K registros)</p>"},{"location":"guias/storage_configuracion/#configuracion-basica","title":"Configuraci\u00f3n B\u00e1sica","text":"<p>Solo es necesario especificar el nombre del bucket. El sistema se encarga de generar la ruta y el nombre del archivo.</p> <pre><code>{\n  \"id\": \"mi_fuente\",\n  \"type\": \"api\",\n  \"storage\": {\n    \"bucket\": \"raw-data\"\n  }\n}\n</code></pre>"},{"location":"guias/storage_configuracion/#parametros-disponibles","title":"Par\u00e1metros Disponibles","text":"Par\u00e1metro Descripci\u00f3n Valor por defecto <code>bucket</code> Nombre del bucket en Supabase. <code>\"raw-data\"</code> <code>path</code> (Opcional) Ruta completa del archivo. Si se define, sobrescribe la generaci\u00f3n autom\u00e1tica de historial. \u00datil si solo se desea mantener la \u00faltima versi\u00f3n. <code>None</code> (Autom\u00e1tico) <p>Nota: Para historiales, es recomendable omitir <code>path</code> y dejar que el sistema genere la ruta con timestamp autom\u00e1ticamente.</p>"},{"location":"guias/storage_configuracion/#limpieza-de-datos-antiguos","title":"Limpieza de Datos Antiguos","text":"<p>El sistema est\u00e1 dise\u00f1ado para retener historial de 2-3 meses. Para mantener la capacidad bajo control:</p> <ol> <li>Estrategia autom\u00e1tica: Implementar un job de limpieza que elimine datos &gt; 90 d\u00edas</li> <li>Manual: Usar la consola de Supabase para eliminar carpetas antiguas</li> </ol>"},{"location":"guias/transform_process/","title":"Transform","text":"<p>M\u00f3dulo de transformaci\u00f3n de datos RAW a estructura normalizada para carga en PostgreSQL.</p>"},{"location":"guias/transform_process/#arquitectura","title":"Arquitectura","text":"<p>El m\u00f3dulo <code>transformers/</code> sigue el patr\u00f3n Strategy, permitiendo transformaciones espec\u00edficas seg\u00fan el tipo de fuente de datos:</p> <pre><code>transformers/\n\u251c\u2500\u2500 __init__.py          # Registry de transformers\n\u251c\u2500\u2500 base.py              # Clase abstracta BaseTransformer\n\u251c\u2500\u2500 schemas.py           # Modelos Pydantic para validaci\u00f3n\n\u251c\u2500\u2500 api.py               # Transforma JSON de APIs (Socrata)\n\u251c\u2500\u2500 excel.py             # Transforma archivos Excel (UPME, MinMinas)\n\u251c\u2500\u2500 custom.py            # Ejecuta scripts custom\n\u2514\u2500\u2500 custom_scripts/      # Scripts de transformaci\u00f3n personalizados\n    \u2514\u2500\u2500 __example_transformer.py\n</code></pre>"},{"location":"guias/transform_process/#flujo-de-transformacion","title":"Flujo de Transformaci\u00f3n","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Archivo RAW       \u2502 (JSON/Excel/bytes desde Supabase Storage)\n\u2502   (Storage)         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n           \u2502\n           \u251c\u2500 get_transformer(source_type)\n           \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Transformer       \u2502 (api.py / excel.py / custom.py)\n\u2502   (parse + validate)\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n           \u2502\n           \u251c\u2500 Parsear contenido seg\u00fan formato\n           \u251c\u2500 Validar con Pydantic schemas\n           \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Estructura         \u2502 {\"valid_records\": [...],\n\u2502  Normalizada        \u2502  \"errors\": [...],\n\u2502                     \u2502  \"stats\": {...}}\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n           \u2502\n           \u251c\u2500 Listo para Loader\n           \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   PostgreSQL        \u2502 (fact_regalias, fact_demanda_gas, etc.)\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"guias/transform_process/#uso","title":"Uso","text":""},{"location":"guias/transform_process/#1-obtener-transformer","title":"1. Obtener Transformer","text":"<pre><code>from workflows.full_etl.transformers import get_transformer\n\n# Obtener transformer seg\u00fan tipo de fuente\ntransformer = get_transformer(\"api\")  # ApiTransformer\ntransformer = get_transformer(\"complex_scraper\")  # CustomTransformer\n</code></pre>"},{"location":"guias/transform_process/#2-transformar-datos","title":"2. Transformar Datos","text":"<pre><code># Cargar datos RAW desde Storage\nraw_data = supabase.storage.from_(\"raw-data\").download(\"api/api_regalias/2024-11-25_120000.json\")\n\n# Transformar\nresult = transformer.transform(raw_data, source_config)\n\n# Resultado\nprint(f\"V\u00e1lidos: {len(result['valid_records'])}\")\nprint(f\"Errores: {len(result['errors'])}\")\n</code></pre>"},{"location":"guias/transform_process/#3-estructura-del-resultado","title":"3. Estructura del Resultado","text":"<pre><code>{\n    \"valid_records\": [\n        {\n            \"fact_table\": \"fact_regalias\",\n            \"data\": {\n                \"tiempo_fecha\": \"2024-01-01\",\n                \"campo_nombre\": \"RUBIALES\",\n                \"tipo_hidrocarburo\": \"G\",\n                \"precio_usd\": 3.45,\n                ...\n            },\n            \"dimensions\": {\n                \"tiempo\": {\n                    \"fecha\": \"2024-01-01\",\n                    \"anio\": 2024,\n                    \"mes\": 1,\n                    \"es_proyeccion\": False\n                },\n                \"territorio\": {\n                    \"departamento\": \"META\",\n                    \"municipio\": \"ACACIAS\",\n                    \"latitud\": 3.98,\n                    \"longitud\": -73.76\n                },\n                \"campo\": {\n                    \"nombre_campo\": \"RUBIALES\",\n                    \"contrato\": \"LLANOS 5\",\n                    \"activo\": True\n                }\n            }\n        },\n        ...\n    ],\n    \"errors\": [\n        {\n            \"record_index\": 123,\n            \"error\": \"ValidationError: campo 'precio_usd' debe ser &gt;= 0\",\n            \"raw_record\": {...}\n        },\n        ...\n    ],\n    \"stats\": {\n        \"total_raw\": 1000,\n        \"valid\": 995,\n        \"errors\": 5,\n        \"processing_time_seconds\": 12.5,\n        \"error_categories\": {\n            \"Porcentaje regal\u00eda fuera de rango\": 3,\n            \"Tipo hidrocarburo inv\u00e1lido\": 2\n        }\n    }\n}\n</code></pre>"},{"location":"guias/transform_process/#transformers-disponibles","title":"Transformers Disponibles","text":""},{"location":"guias/transform_process/#apitransformer-apipy","title":"ApiTransformer (<code>api.py</code>)","text":"<p>Transforma JSON de APIs (principalmente Socrata). Gen\u00e9rico y parametrizado mediante <code>TransformationConfig</code>.</p> <p>Fuentes soportadas: - <code>api_regalias</code> \u2192 ANH Consolidaci\u00f3n de Regal\u00edas \u2192 <code>fact_regalias</code> - Extensible: cualquier API Socrata registrando config en <code>CONFIG_REGISTRY</code></p> <p>Caracter\u00edsticas: - Parseo r\u00e1pido con orjson (fallback a json) - Pre-validaciones vectorizadas en pandas (masivas, eficientes) - Derivaci\u00f3n de columnas parametrizada - Mapeo gen\u00e9rico a fact tables + dimensiones - Dirigido por config: sin c\u00f3digo hardcodeado por fuente</p> <p>Ejemplo de uso: <pre><code>from workflows.full_etl.transformers import ApiTransformer\n\ntransformer = ApiTransformer()\nresult = transformer.transform(json_data, {\"id\": \"api_regalias\"})\n</code></pre></p>"},{"location":"guias/transform_process/#exceltransformer-excelpy","title":"ExcelTransformer (<code>excel.py</code>)","text":"<p>Transforma archivos Excel (UPME, MinMinas).</p> <p>Fuentes soportadas: - <code>upme_gas_natural</code> \u2192 Proyecci\u00f3n Gas Natural \u2192 <code>fact_demanda_gas_natural</code> - <code>upme_energia_electrica</code> \u2192 Proyecci\u00f3n Energ\u00eda El\u00e9ctrica \u2192 <code>fact_energia_electrica</code> - <code>upme_potencia_maxima</code> \u2192 Proyecci\u00f3n Potencia M\u00e1xima \u2192 <code>fact_potencia_maxima</code> - <code>upme_capacidad_instalada</code> \u2192 Capacidad Instalada GD \u2192 <code>fact_capacidad_instalada</code> - <code>minminas_oferta</code> \u2192 Declaraci\u00f3n de Producci\u00f3n \u2192 <code>fact_oferta_gas</code></p> <p>Caracter\u00edsticas: - Parseo con Pandas + OpenPyXL - Soporte para m\u00faltiples hojas - Conversi\u00f3n autom\u00e1tica de unidades (KPCD/MPCD \u2192 GBTUD) - Validaci\u00f3n de CHECK constraints</p> <p>Ejemplo de uso: <pre><code>from workflows.full_etl.transformers import ExcelTransformer\n\ntransformer = ExcelTransformer()\nresult = transformer.transform(excel_bytes, source_config)\n</code></pre></p>"},{"location":"guias/transform_process/#customtransformer-custompy","title":"CustomTransformer (<code>custom.py</code>)","text":"<p>Ejecuta scripts de transformaci\u00f3n personalizados.</p> <p>Convenci\u00f3n: - Scripts en: <code>transformers/custom_scripts/{source_id}_transformer.py</code> - Debe exponer: <code>transform(raw_data, source_config) \u2192 dict</code></p> <p>Ejemplo de script custom: <pre><code># custom_scripts/banco_central_transformer.py\n\ndef transform(raw_data, source_config):\n    valid_records = []\n    errors = []\n\n    # Tu l\u00f3gica de transformaci\u00f3n aqu\u00ed\n\n    return {\n        \"valid_records\": valid_records,\n        \"errors\": errors,\n        \"stats\": {\n            \"total_raw\": len(valid_records) + len(errors),\n            \"valid\": len(valid_records),\n            \"errors\": len(errors)\n        }\n    }\n</code></pre></p>"},{"location":"guias/transform_process/#schemas-de-validacion-schemaspy","title":"Schemas de Validaci\u00f3n (<code>schemas.py</code>)","text":""},{"location":"guias/transform_process/#tablas-de-hechos","title":"Tablas de Hechos","text":""},{"location":"guias/transform_process/#factregaliasschema","title":"FactRegaliasSchema","text":"<pre><code>tiempo_fecha: date\ncampo_nombre: str\ntipo_hidrocarburo: TipoHidrocarburo  # \"G\" o \"O\"\nprecio_usd: Decimal (ge=0, decimal_places=4)\nporcentaje_regalia: Decimal (ge=0, le=100, decimal_places=2)\nproduccion_gravable: Decimal (ge=0, decimal_places=4)\nvolumen_regalia: Decimal (ge=0, decimal_places=4)\nvalor_regalias_cop: Decimal (ge=0, decimal_places=2)\n</code></pre>"},{"location":"guias/transform_process/#factdemandagasnaturalschema","title":"FactDemandaGasNaturalSchema","text":"<pre><code>tiempo_fecha: date\nperiodicidad: str  # \"mensual\", \"anual\"\ncategoria: str  # COMPRESORES, INDUSTRIAL, PETROLERO, PETROQUIMICO, RESIDENCIAL, TERCIARIO, TERMOELECTRICO, GNC_TRANSPORTE, GNL_TRANSPORTE, AGREGADO\nregion: str  # Regi\u00f3n geogr\u00e1fica\nnodo: str  # Nodo espec\u00edfico (opcional)\nescenario: str  # ESC_BAJO, ESC_MEDIO, ESC_ALTO\nvalor: Decimal (ge=0, decimal_places=6)\nrevision: str  # REV_JULIO_2025, REV_DIC_2023, etc.\n</code></pre>"},{"location":"guias/transform_process/#factenergiaelectricaschema","title":"FactEnergiaElectricaSchema","text":"<pre><code>tiempo_fecha: date\nperiodicidad: str  # \"mensual\", \"anual\"\nunidad: str  # GWh-mes, GWh-a\u00f1o\narea_id: int\ndescriptor: str\nescenario: str  # ESC_BAJO, ESC_MEDIO, ESC_ALTO, IC_SUP_95, IC_INF_95, IC_SUP_68, IC_INF_68\nrevision: str\nvalor: Decimal (ge=0, decimal_places=6)\n</code></pre>"},{"location":"guias/transform_process/#factpotenciamaximaschema","title":"FactPotenciaMaximaSchema","text":"<pre><code>tiempo_fecha: date\nperiodicidad: str  # \"mensual\", \"anual\"\nunidad: str  # MW-mes, MW-a\u00f1o\narea_id: int\ndescriptor: str\nescenario: str  # ESC_BAJO, ESC_MEDIO, ESC_ALTO, IC_SUP_*, IC_INF_*\nrevision: str\nvalor: Decimal (ge=0, decimal_places=6)\n</code></pre>"},{"location":"guias/transform_process/#factofertagasschema","title":"FactOfertaGasSchema","text":"<pre><code>tiempo_fecha: date\ncampo_nombre: str\nresolucion_id: int\ntipo_produccion: str  # PTDV, PC_CONTRATOS, PC_EXPORTACIONES, PP, GAS_OPERACION, CIDV\noperador: str\nes_operador_campo: bool\nes_participacion_estado: bool\nvalor_gbtud: Decimal (ge=0, decimal_places=6)\npoder_calorifico_btu_pc: Decimal (optional)\n</code></pre>"},{"location":"guias/transform_process/#dimensiones","title":"Dimensiones","text":""},{"location":"guias/transform_process/#dimtiemposchema","title":"DimTiempoSchema","text":"<pre><code>fecha: date\nanio: int (ge=1900, le=2100)\nmes: int (ge=1, le=12)\nnombre_mes: str  # \"Enero\", \"Febrero\", etc.\nes_proyeccion: bool\n</code></pre>"},{"location":"guias/transform_process/#dimterritorioschema","title":"DimTerritorioSchema","text":"<pre><code>departamento: str\nmunicipio: str\nlatitud: Decimal (ge=-90, le=90, decimal_places=7)\nlongitud: Decimal (ge=-180, le=180, decimal_places=7)\ndivipola: str (min_length=5, max_length=5)\n</code></pre>"},{"location":"guias/transform_process/#dimcamposchema","title":"DimCampoSchema","text":"<pre><code>nombre_campo: str\ncontrato: str\noperador: str\nasociados: List[str]\nparticipacion_estado: Decimal (ge=0, le=100, decimal_places=2)\nterritorio_id: int\nactivo: bool\n</code></pre>"},{"location":"guias/transform_process/#dimareaselectricasschema","title":"DimAreasElectricasSchema","text":"<pre><code>codigo: str  # C\u00f3digo \u00fanico del \u00e1rea\nnombre: str  # Nombre del \u00e1rea\ncategoria: str  # nacional, area_sin, combinado, gd, proyecto\ndescripcion: str\n</code></pre>"},{"location":"guias/transform_process/#dimresolucionesschema","title":"DimResolucionesSchema","text":"<pre><code>numero_resolucion: str\nfecha_resolucion: date\nperiodo_desde: date\nperiodo_hasta: date\nurl_pdf: str (optional)\nurl_soporte_magnetico: str (optional)\n</code></pre>"},{"location":"guias/transform_process/#agregar-nuevo-transformer","title":"Agregar Nuevo Transformer","text":""},{"location":"guias/transform_process/#1-para-api-nueva","title":"1. Para API nueva:","text":"<p>Editar <code>api.py</code>: <pre><code>def _get_transformer_function(self, source_id: str):\n    transformers = {\n        \"api_regalias\": self._transform_socrata_regalias,\n        \"nueva_api\": self._transform_nueva_api,  # \u2190 Agregar\n    }\n    return transformers.get(source_id, self._transform_generic_json)\n\ndef _transform_nueva_api(self, raw_record, source_id):\n    # Tu l\u00f3gica aqu\u00ed\n    pass\n</code></pre></p>"},{"location":"guias/transform_process/#2-para-excel-nuevo","title":"2. Para Excel nuevo:","text":"<p>Editar <code>excel.py</code>: <pre><code>def _get_transformer_function(self, source_id: str):\n    transformers = {\n        \"upme_demanda\": self._transform_upme_demanda,\n        \"minminas_oferta\": self._transform_minminas_oferta,\n        \"nuevo_excel\": self._transform_nuevo_excel,  # \u2190 Agregar\n    }\n    return transformers.get(source_id, self._transform_generic_excel)\n\ndef _transform_nuevo_excel(self, excel_file, source_id):\n    # Tu l\u00f3gica aqu\u00ed\n    return valid_records, errors\n</code></pre></p>"},{"location":"guias/transform_process/#3-para-script-totalmente-custom","title":"3. Para script totalmente custom:","text":"<p>Crear archivo <code>custom_scripts/{source_id}_transformer.py</code> con funci\u00f3n <code>transform()</code>.</p>"},{"location":"guias/transform_process/#validacion-de-datos","title":"Validaci\u00f3n de Datos","text":"<p>En ApiTransformer (parametrizado): - Pre-validaciones vectorizadas en pandas (antes de mapear) - Reglas definidas en <code>TransformationConfig.column_validations</code> - Tipos: RANGE, ENUM, NON_NEGATIVE, BETWEEN_0_100, DATE_VALID, etc. - Cada violaci\u00f3n genera error sin detener procesamiento</p> <p>Ejemplo de regla de validaci\u00f3n: <pre><code># En config.py\nColumnValidation(\n    column=\"porcregalia\",\n    rule=ValidationRule.BETWEEN_0_100,\n    error_message=\"Porcentaje regal\u00eda fuera de rango\"\n)\n</code></pre></p> <p>En ExcelTransformer &amp; CustomTransformer: - Pueden usar schemas Pydantic (e.g., <code>FactRegaliasSchema</code>) - Validaci\u00f3n exhaustiva post-extracci\u00f3n - Genera <code>ValidationError</code> capturado en estructura de errores</p>"},{"location":"guias/transform_process/#manejo-de-errores","title":"Manejo de Errores","text":"<p>Los transformers NO detienen el procesamiento ante errores de validaci\u00f3n individual. En su lugar:</p> <ol> <li>Registro inv\u00e1lido \u2192 Se agrega a <code>errors[]</code></li> <li>Contin\u00faa procesando siguientes registros</li> <li>Al final retorna todos los v\u00e1lidos + todos los errores</li> </ol> <p>Esto permite: - Cargar datos parciales (registros v\u00e1lidos) - Auditar errores para correcci\u00f3n manual - No perder todo el batch por un solo registro corrupto</p> <p>Ejemplo de error: <pre><code>{\n    \"record_index\": 123,\n    \"error\": \"1 validation error for FactRegaliasSchema\\nprecio_usd\\n  Input should be greater than or equal to 0\",\n    \"raw_record\": {\n        \"departamento\": \"META\",\n        \"campo\": \"RUBIALES\",\n        \"precio_usd\": -5.0,\n        ...\n    }\n}\n</code></pre></p>"},{"location":"guias/transform_process/#testing","title":"Testing","text":"<pre><code># Test b\u00e1sico de transformer\nfrom workflows.full_etl.transformers import get_transformer\n\nsource_config = {\n    \"id\": \"api_regalias\",\n    \"type\": \"api\",\n    ...\n}\n\nraw_data = '{\"data\": [{\"departamento\": \"META\", ...}]}'\n\ntransformer = get_transformer(\"api\")\nresult = transformer.transform(raw_data, source_config)\n\nassert result[\"stats\"][\"valid\"] &gt; 0\nassert len(result[\"valid_records\"]) == result[\"stats\"][\"valid\"]\n</code></pre>"},{"location":"guias/transform_process/#documentacion-complementaria","title":"Documentaci\u00f3n Complementaria","text":"<ul> <li><code>api_transformer_extension.md</code>: Gu\u00eda paso-a-paso para extender ApiTransformer a nuevas fuentes</li> </ul>"}]}